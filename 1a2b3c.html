<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARMONIA - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    .logo p {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: block;
    }

    .navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-brand {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .btn-logout {
      padding: 8px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .container {
      display: flex;
      min-height: calc(100vh - 70px);
    }

    .sidebar {
      width: 260px;
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      padding: 20px 0;
    }

    .sidebar-item {
      padding: 15px 30px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      color: #666;
    }

    .sidebar-item:hover {
      background: #f5f5f5;
      color: #667eea;
    }

    .sidebar-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-left: 4px solid #764ba2;
    }

    .sidebar-item-icon {
      font-size: 20px;
    }

    .main-content {
      flex: 1;
      padding: 30px;
      background: #f8f9fa;
      overflow-y: auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-header h2 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }

    .page-header p {
      color: #666;
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .stat-card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .stat-card-icon.blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stat-card-icon.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .stat-card-icon.orange {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .stat-card-icon.purple {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .stat-card-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .card-header h3 {
      font-size: 20px;
      color: #333;
    }

    .btn-secondary {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #666;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .btn-icon {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 3px;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-icon.edit {
      background: #2196f3;
      color: white;
    }

    .btn-icon.delete {
      background: #f44336;
      color: white;
    }

    .btn-icon.view {
      background: #4caf50;
      color: white;
    }

    .btn-icon:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      font-size: 22px;
      color: #333;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .btn-close:hover {
      color: #333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        z-index: 999;
        display: flex;
        padding: 10px 0;
        overflow-x: auto;
      }

      .sidebar-item {
        flex-direction: column;
        padding: 10px 15px;
        min-width: 80px;
        text-align: center;
        font-size: 12px;
      }

      .container {
        flex-direction: column;
        padding-bottom: 80px;
      }

      .main-content {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .navbar {
        padding: 15px;
      }

      .navbar-brand {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container" id="loginScreen">
    <div class="login-card">
      <div class="logo">
        <h1>üéÆ HARMONIA</h1>
        <p>Admin Panel</p>
      </div>
      <div id="loginError" class="error-message" style="display: none;"></div>
      <form id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" required placeholder="admin@harmonia.com">
        </div>
        <div class="form-group">
          <label>Mot de passe</label>
          <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" class="btn-primary" id="loginBtn">
          Se connecter
        </button>
      </form>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <nav class="navbar">
      <div class="navbar-brand">üéÆ HARMONIA Admin</div>
      <div class="navbar-user">
        <span id="adminEmail"></span>
        <button class="btn-logout" onclick="logout()">D√©connexion</button>
      </div>
    </nav>

    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-item active" onclick="showPage('dashboard')">
          <span class="sidebar-item-icon">üìä</span>
          <span>Dashboard</span>
        </div>
        <div class="sidebar-item" onclick="showPage('sections')">
          <span class="sidebar-item-icon">üìö</span>
          <span>Sections</span>
        </div>
        <div class="sidebar-item" onclick="showPage('parts')">
          <span class="sidebar-item-icon">üéØ</span>
          <span>Parts</span>
        </div>
        <div class="sidebar-item" onclick="showPage('runs')">
          <span class="sidebar-item-icon">üéÆ</span>
          <span>Runs</span>
        </div>
        <div class="sidebar-item" onclick="showPage('actualites')">
          <span class="sidebar-item-icon">üì∞</span>
          <span>Actualit√©s</span>
        </div>
        <div class="sidebar-item" onclick="showPage('users')">
          <span class="sidebar-item-icon">üë•</span>
          <span>Utilisateurs</span>
        </div>
        <div class="sidebar-item" onclick="showPage('analytics')">
          <span class="sidebar-item-icon">üìà</span>
          <span>Analytics</span>
        </div>
      </aside>

      <main class="main-content">
        <div class="page active" id="page-dashboard">
          <div class="page-header">
            <h2>Tableau de bord</h2>
            <p>Vue d'ensemble de la plateforme HARMONIA</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-icon blue">üë•</div>
              <div class="stat-card-label">Utilisateurs totaux</div>
              <div class="stat-card-value" id="stat-users">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-icon green">üìö</div>
              <div class="stat-card-label">Sections actives</div>
              <div class="stat-card-value" id="stat-sections">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-icon orange">üéÆ</div>
              <div class="stat-card-label">Runs en cours</div>
              <div class="stat-card-value" id="stat-runs">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-icon purple">üí∞</div>
              <div class="stat-card-label">Revenus totaux</div>
              <div class="stat-card-value" id="stat-revenue">0‚Ç¨</div>
            </div>
          </div>
        </div>

        <div class="page" id="page-sections">
          <div class="page-header">
            <h2>Gestion des Sections</h2>
            <p>Cr√©er et g√©rer les sections de jeu</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Liste des Sections</h3>
              <button class="btn-secondary" onclick="openModal('createSection')">+ Nouvelle Section</button>
            </div>
            <div class="table-container">
              <table id="sectionsTable">
                <thead>
                  <tr>
                    <th>Titre</th>
                    <th>Description</th>
                    <th>Co√ªt</th>
                    <th>Publique</th>
                    <th>Cr√©√©e le</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="sectionsTableBody">
                  <tr>
                    <td colspan="6" class="loading">
                      <div class="spinner"></div>
                      Chargement...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="page" id="page-parts">
          <div class="page-header">
            <h2>Gestion des Parts</h2>
            <p>Cr√©er et g√©rer les parts des sections</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Liste des Parts</h3>
              <button class="btn-secondary" onclick="openModal('createPart')">+ Nouvelle Part</button>
            </div>
            <div class="table-container">
              <table id="partsTable">
                <thead>
                  <tr>
                    <th>Section</th>
                    <th>Ordre</th>
                    <th>Titre</th>
                    <th>Active</th>
                    <th>Acc√®s</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="partsTableBody">
                  <tr>
                    <td colspan="6" class="loading">
                      <div class="spinner"></div>
                      Chargement...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="page" id="page-runs">
          <div class="page-header">
            <h2>Gestion des Runs</h2>
            <p>Cr√©er et g√©rer les questions de jeu</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Liste des Runs</h3>
              <button class="btn-secondary" onclick="openModal('createRun')">+ Nouveau Run</button>
            </div>
            <div class="table-container">
              <table id="runsTable">
                <thead>
                  <tr>
                    <th>Part</th>
                    <th>N¬∞</th>
                    <th>Question</th>
                    <th>Temps</th>
                    <th>R√©ponse</th>
                    <th>Statut</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="runsTableBody">
                  <tr>
                    <td colspan="7" class="loading">
                      <div class="spinner"></div>
                      Chargement...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="page" id="page-actualites">
          <div class="page-header">
            <h2>Gestion des Actualit√©s</h2>
            <p>Publier et g√©rer les actualit√©s</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Liste des Actualit√©s</h3>
              <button class="btn-secondary" onclick="openModal('createActualite')">+ Nouvelle Actualit√©</button>
            </div>
            <div class="table-container">
              <table id="actualitesTable">
                <thead>
                  <tr>
                    <th>Titre</th>
                    <th>Contenu</th>
                    <th>Image</th>
                    <th>Cr√©√©e le</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="actualitesTableBody">
                  <tr>
                    <td colspan="5" class="loading">
                      <div class="spinner"></div>
                      Chargement...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="page" id="page-users">
          <div class="page-header">
            <h2>Gestion des Utilisateurs</h2>
            <p>G√©rer les utilisateurs et leurs r√¥les</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Liste des Utilisateurs</h3>
            </div>
            <div class="table-container">
              <table id="usersTable">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>R√¥le</th>
                    <th>Statut</th>
                    <th>Cr√©√© le</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr>
                    <td colspan="6" class="loading">
                      <div class="spinner"></div>
                      Chargement...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="page" id="page-analytics">
          <div class="page-header">
            <h2>Analytics & Statistiques</h2>
            <p>Analyse d√©taill√©e de la plateforme</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>R√©ponses des Joueurs</h3>
            </div>
            <div class="table-container" id="analyticsAnswers">
              <div class="loading">
                <div class="spinner"></div>
                Chargement...
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Top Scores</h3>
            </div>
            <div class="table-container" id="analyticsScores">
              <div class="loading">
                <div class="spinner"></div>
                Chargement...
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Paiements</h3>
            </div>
            <div class="table-container" id="analyticsPayments">
              <div class="loading">
                <div class="spinner"></div>
                Chargement...
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div class="modal" id="modalCreateSection">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cr√©er une Section</h3>
        <button class="btn-close" onclick="closeModal('createSection')">&times;</button>
      </div>
      <form id="formCreateSection">
        <div class="form-group">
          <label>Titre *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description"></textarea>
        </div>
        <div class="form-group">
          <label>Co√ªt de participation</label>
          <input type="number" name="participation_cost" value="0" min="0" step="0.01">
        </div>
        <div class="checkbox-group">
          <input type="checkbox" name="is_public" id="is_public" checked>
          <label for="is_public">Section publique</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" name="allow_join" id="allow_join" checked>
          <label for="allow_join">Autoriser les inscriptions</label>
        </div>
        <button type="submit" class="btn-primary">Cr√©er la section</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalCreatePart">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cr√©er une Part</h3>
        <button class="btn-close" onclick="closeModal('createPart')">&times;</button>
      </div>
      <form id="formCreatePart">
        <div class="form-group">
          <label>Section *</label>
          <select name="section_id" required id="selectSection">
            <option value="">Chargement...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Num√©ro d'ordre *</label>
          <input type="number" name="order_number" required min="1" id="partOrderNumber">
          <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
            ‚ö†Ô∏è La premi√®re part (ordre 1) ne peut pas avoir de conditions d'acc√®s
          </small>
        </div>
        <div class="form-group">
          <label>Titre</label>
          <input type="text" name="title">
        </div>
        <div id="accessConditionsBlock">
          <div class="form-group">
            <label>Part source pour le score (optionnel)</label>
            <select name="access_score_source_part" id="selectSourcePart">
              <option value="">Aucune condition de score</option>
            </select>
            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
              S√©lectionnez la part dont le score sera utilis√© comme r√©f√©rence
            </small>
          </div>
          <div class="form-group">
            <label>Score minimum requis</label>
            <input type="number" name="access_score_min" min="0" id="accessScoreMin">
          </div>
          <div class="form-group">
            <label>Top classement requis</label>
            <input type="number" name="access_rank_top" min="1" id="accessRankTop">
          </div>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" name="is_active" id="is_active_part">
          <label for="is_active_part">Part active</label>
        </div>
        <button type="submit" class="btn-primary">Cr√©er la part</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalCreateRun">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cr√©er un Run</h3>
        <button class="btn-close" onclick="closeModal('createRun')">&times;</button>
      </div>
      <form id="formCreateRun">
        <div class="form-group">
          <label>Part *</label>
          <select name="part_id" required id="selectPart">
            <option value="">Chargement...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Num√©ro du run *</label>
          <input type="number" name="run_number" required min="1">
        </div>
        <div class="form-group">
          <label>Question *</label>
          <textarea name="question" required></textarea>
        </div>
        <div class="form-group">
          <label>Temps limite (secondes) *</label>
          <input type="number" name="time_limit" required min="10" value="60">
        </div>
        <div class="form-group">
          <label>R√©ponse correcte *</label>
          <select name="admin_answer" required>
            <option value="">S√©lectionner...</option>
            <option value="true">VRAI</option>
            <option value="false">FAUX</option>
          </select>
        </div>
        <button type="submit" class="btn-primary">Cr√©er le run</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalCreateActualite">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cr√©er une Actualit√©</h3>
        <button class="btn-close" onclick="closeModal('createActualite')">&times;</button>
      </div>
      <form id="formCreateActualite">
        <div class="form-group">
          <label>Titre *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Contenu *</label>
          <textarea name="content" required rows="6"></textarea>
        </div>
        <div class="form-group">
          <label>URL de l'image</label>
          <input type="url" name="image_url" placeholder="https://...">
        </div>
        <button type="submit" class="btn-primary">Publier l'actualit√©</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalDistributePoints">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Distribuer les Points</h3>
        <button class="btn-close" onclick="closeModal('distributePoints')">&times;</button>
      </div>
      <form id="formDistributePoints">
        <input type="hidden" name="run_id" id="distributeRunId">
        <div class="form-group">
          <label>Points par bonne r√©ponse *</label>
          <input type="number" name="points" required min="1" value="10">
        </div>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
          ‚ö†Ô∏è Cette action distribuera les points √† tous les joueurs ayant donn√© la bonne r√©ponse.
        </p>
        <button type="submit" class="btn-primary">Distribuer les points</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalUpdateUser">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Modifier l'utilisateur</h3>
        <button class="btn-close" onclick="closeModal('updateUser')">&times;</button>
      </div>
      <form id="formUpdateUser">
        <input type="hidden" name="user_id" id="updateUserId">
        <div class="form-group">
          <label>R√¥le</label>
          <select name="role" id="updateUserRole">
            <option value="player">Joueur</option>
            <option value="moderator">Mod√©rateur</option>
            <option value="admin">Administrateur</option>
          </select>
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select name="status" id="updateUserStatus">
            <option value="active">Actif</option>
            <option value="inactive">Inactif</option>
            <option value="banned">Banni</option>
          </select>
        </div>
        <button type="submit" class="btn-primary">Mettre √† jour</button>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dfccebkmiebkqfwdudjg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmY2NlYmttaWVia3Fmd2R1ZGpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NzU4MzcsImV4cCI6MjA4MjM1MTgzN30.4M3L0X-Ej2PfzagRnPd9q6QyyvG1MkmCeucRf-_Mxzc';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null;
    let allSections = [];
    let allParts = [];

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      const errorDiv = document.getElementById('loginError');

      btn.disabled = true;
      btn.textContent = 'Connexion...';
      errorDiv.style.display = 'none';

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        const { data: userData, error: userError } = await supabaseClient
          .from('users')
          .select('role, email, username')
          .eq('auth_uid', data.user.id)
          .single();

        if (userError || userData.role !== 'admin') {
          await supabaseClient.auth.signOut();
          throw new Error('Acc√®s refus√© - Vous devez √™tre administrateur');
        }

        currentUser = userData;
        document.getElementById('adminEmail').textContent = userData.email;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        loadDashboardData();
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Se connecter';
      }
    });

    async function logout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('loginForm').reset();
    }

    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
      
      document.getElementById(`page-${pageName}`).classList.add('active');
      event.target.closest('.sidebar-item').classList.add('active');

      if (pageName === 'sections') loadSections();
      if (pageName === 'parts') loadParts();
      if (pageName === 'runs') loadRuns();
      if (pageName === 'actualites') loadActualites();
      if (pageName === 'users') loadUsers();
      if (pageName === 'analytics') loadAnalytics();
    }

    function openModal(modalName) {
      document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`).classList.add('active');
      
      if (modalName === 'createPart') loadSectionsSelect();
      if (modalName === 'createRun') loadPartsSelect();
    }

    function closeModal(modalName) {
      document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`).classList.remove('active');
    }

    async function loadDashboardData() {
      try {
        const [
          { count: usersCount },
          { count: sectionsCount },
          { count: runsCount },
          { data: payments }
        ] = await Promise.all([
          supabaseClient.from('users').select('*', { count: 'exact', head: true }),
          supabaseClient.from('sections').select('*', { count: 'exact', head: true }),
          supabaseClient.from('runs').select('*', { count: 'exact', head: true }).eq('is_closed', false),
          supabaseClient.from('payments').select('amount, status').eq('status', 'completed')
        ]);

        document.getElementById('stat-users').textContent = usersCount || 0;
        document.getElementById('stat-sections').textContent = sectionsCount || 0;
        document.getElementById('stat-runs').textContent = runsCount || 0;
        
        const totalRevenue = payments?.reduce((sum, p) => sum + parseFloat(p.amount), 0) || 0;
        document.getElementById('stat-revenue').textContent = totalRevenue.toFixed(2) + '‚Ç¨';
      } catch (error) {
        console.error('Erreur dashboard:', error);
      }
    }

    async function loadSections() {
      const tbody = document.getElementById('sectionsTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Chargement...</td></tr>';

      try {
        const { data: sections, error } = await supabaseClient
          .from('sections')
          .select('*, users(username)')
          .order('created_at', { ascending: false });

        if (error) throw error;
        allSections = sections;

        if (sections.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Aucune section</td></tr>';
          return;
        }

        tbody.innerHTML = sections.map(s => `
          <tr>
            <td><strong>${s.title}</strong></td>
            <td>${s.description || '-'}</td>
            <td>${s.participation_cost}‚Ç¨</td>
            <td><span class="badge ${s.is_public ? 'badge-success' : 'badge-warning'}">${s.is_public ? 'Oui' : 'Non'}</span></td>
            <td>${new Date(s.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
              <button class="btn-icon delete" onclick="deleteSection('${s.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f44336;">Erreur: ' + error.message + '</td></tr>';
      }
    }

    async function loadParts() {
      const tbody = document.getElementById('partsTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Chargement...</td></tr>';

      try {
        const { data: parts, error } = await supabaseClient
          .from('parts')
          .select('*, sections(title)')
          .order('section_id', { ascending: true })
          .order('order_number', { ascending: true });

        if (error) throw error;
        allParts = parts;

        if (parts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Aucune part</td></tr>';
          return;
        }

        tbody.innerHTML = parts.map(p => `
          <tr>
            <td>${p.sections?.title || '-'}</td>
            <td><strong>#${p.order_number}</strong></td>
            <td>${p.title || '-'}</td>
            <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-warning'}">${p.is_active ? 'Oui' : 'Non'}</span></td>
            <td>
              <small>
                ${p.order_number === 1 
                  ? '<span class="badge badge-info">Pas de conditions</span>' 
                  : `
                    ${p.access_score_source_part ? 'üìä Score source d√©fini | ' : ''}
                    Score: ${p.access_score_min || '-'} | 
                    Top: ${p.access_rank_top || '-'}
                  `}
              </small>
            </td>
            <td>
              <button class="btn-icon delete" onclick="deletePart('${p.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f44336;">Erreur: ' + error.message + '</td></tr>';
      }
    }

    async function loadRuns() {
      const tbody = document.getElementById('runsTableBody');
      tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Chargement...</td></tr>';

      try {
        const { data: runs, error } = await supabaseClient
          .from('runs')
          .select('*, parts(title, sections(title))')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (runs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#666;">Aucun run</td></tr>';
          return;
        }

        tbody.innerHTML = runs.map(r => `
          <tr>
            <td><small>${r.parts?.sections?.title || '-'} / ${r.parts?.title || '-'}</small></td>
            <td><strong>#${r.run_number}</strong></td>
            <td>${r.question.substring(0, 50)}...</td>
            <td>${r.time_limit}s</td>
            <td><span class="badge ${r.admin_answer ? 'badge-success' : 'badge-danger'}">${r.admin_answer ? 'VRAI' : 'FAUX'}</span></td>
            <td>
              <span class="badge ${r.is_closed ? 'badge-info' : 'badge-warning'}">${r.is_closed ? 'Ferm√©' : 'Ouvert'}</span>
              ${r.points_distributed ? '<span class="badge badge-success">Points OK</span>' : ''}
            </td>
            <td>
              ${!r.is_closed ? `<button class="btn-icon edit" onclick="closeRun('${r.id}')">üîí Fermer</button>` : ''}
              ${r.is_closed && !r.points_distributed ? `<button class="btn-icon view" onclick="openDistributePoints('${r.id}', '${r.part_id}', ${r.admin_answer})">üí∞ Points</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#f44336;">Erreur: ' + error.message + '</td></tr>';
      }
    }

    async function loadActualites() {
      const tbody = document.getElementById('actualitesTableBody');
      tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div>Chargement...</td></tr>';

      try {
        const { data: posts, error } = await supabaseClient
          .from('posts_actualite')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (posts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;">Aucune actualit√©</td></tr>';
          return;
        }

        tbody.innerHTML = posts.map(p => `
          <tr>
            <td><strong>${p.title}</strong></td>
            <td>${p.content.substring(0, 80)}...</td>
            <td>${p.image_url ? 'üñºÔ∏è Oui' : '-'}</td>
            <td>${new Date(p.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
              <button class="btn-icon delete" onclick="deleteActualite('${p.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#f44336;">Erreur: ' + error.message + '</td></tr>';
      }
    }

    async function loadUsers() {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Chargement...</td></tr>';

      try {
        const { data: users, error } = await supabaseClient
          .from('users')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Aucun utilisateur</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(u => `
          <tr>
            <td><strong>${u.username}</strong></td>
            <td>${u.email}</td>
            <td><span class="badge badge-info">${u.role.toUpperCase()}</span></td>
            <td><span class="badge ${u.status === 'active' ? 'badge-success' : u.status === 'banned' ? 'badge-danger' : 'badge-warning'}">${u.status.toUpperCase()}</span></td>
            <td>${new Date(u.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
              <button class="btn-icon edit" onclick="openUpdateUser('${u.id}', '${u.role}', '${u.status}')">‚úèÔ∏è</button>
              <button class="btn-icon delete" onclick="deleteUser('${u.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f44336;">Erreur: ' + error.message + '</td></tr>';
      }
    }

    async function loadAnalytics() {
      try {
        const { data: answers, error: answersError } = await supabaseClient
          .from('answers')
          .select('*, users(username, email), runs(question)')
          .order('answered_at', { ascending: false })
          .limit(50);

        const answersDiv = document.getElementById('analyticsAnswers');
        if (answers && answers.length > 0) {
          answersDiv.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Utilisateur</th>
                  <th>Question</th>
                  <th>R√©ponse</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${answers.map(a => `
                  <tr>
                    <td>${a.users?.username || 'N/A'}</td>
                    <td>${a.runs?.question?.substring(0, 50) || 'N/A'}...</td>
                    <td><span class="badge ${a.user_answer ? 'badge-success' : 'badge-danger'}">${a.user_answer ? 'VRAI' : 'FAUX'}</span></td>
                    <td>${new Date(a.answered_at).toLocaleString('fr-FR')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          answersDiv.innerHTML = '<p style="text-align:center;color:#666;">Aucune r√©ponse</p>';
        }

        const { data: scores, error: scoresError } = await supabaseClient
          .from('scores')
          .select('*, users(username), parts(title)')
          .order('score', { ascending: false })
          .limit(50);

        const scoresDiv = document.getElementById('analyticsScores');
        if (scores && scores.length > 0) {
          scoresDiv.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Utilisateur</th>
                  <th>Part</th>
                  <th>Score</th>
                  <th>Mis √† jour</th>
                </tr>
              </thead>
              <tbody>
                ${scores.map(s => `
                  <tr>
                    <td>${s.users?.username || 'N/A'}</td>
                    <td>${s.parts?.title || 'N/A'}</td>
                    <td><strong>${s.score}</strong></td>
                    <td>${new Date(s.updated_at).toLocaleDateString('fr-FR')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          scoresDiv.innerHTML = '<p style="text-align:center;color:#666;">Aucun score</p>';
        }

        const { data: payments, error: paymentsError } = await supabaseClient
          .from('payments')
          .select('*, users(username)')
          .order('created_at', { ascending: false })
          .limit(50);

        const paymentsDiv = document.getElementById('analyticsPayments');
        if (payments && payments.length > 0) {
          paymentsDiv.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Utilisateur</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${payments.map(p => `
                  <tr>
                    <td>${p.users?.username || 'N/A'}</td>
                    <td><strong>${parseFloat(p.amount).toFixed(2)}‚Ç¨</strong></td>
                    <td><span class="badge ${p.status === 'completed' ? 'badge-success' : p.status === 'failed' ? 'badge-danger' : 'badge-warning'}">${p.status.toUpperCase()}</span></td>
                    <td>${new Date(p.created_at).toLocaleDateString('fr-FR')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          paymentsDiv.innerHTML = '<p style="text-align:center;color:#666;">Aucun paiement</p>';
        }
      } catch (error) {
        console.error('Erreur analytics:', error);
      }
    }

    async function loadSectionsSelect() {
      const select = document.getElementById('selectSection');
      if (allSections.length === 0) {
        const { data: sections } = await supabaseClient.from('sections').select('*');
        allSections = sections || [];
      }
      select.innerHTML = '<option value="">S√©lectionner une section</option>' + 
        allSections.map(s => `<option value="${s.id}">${s.title}</option>`).join('');
    }

    async function loadPartsSelect() {
      const select = document.getElementById('selectPart');
      const sourcePartSelect = document.getElementById('selectSourcePart');
      
      if (allParts.length === 0) {
        const { data: parts } = await supabaseClient.from('parts').select('*, sections(title)');
        allParts = parts || [];
      }
      
      select.innerHTML = '<option value="">S√©lectionner une part</option>' + 
        allParts.map(p => `<option value="${p.id}">${p.sections?.title || 'N/A'} - Part #${p.order_number} ${p.title ? '(' + p.title + ')' : ''}</option>`).join('');
      
      if (sourcePartSelect) {
        sourcePartSelect.innerHTML = '<option value="">Aucune condition de score</option>' + 
          allParts.map(p => `<option value="${p.id}">${p.sections?.title || 'N/A'} - Part #${p.order_number} ${p.title ? '(' + p.title + ')' : ''}</option>`).join('');
      }
    }

    function openModal(modalName) {
      document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`).classList.add('active');
      
      if (modalName === 'createPart') {
        loadSectionsSelect();
        loadPartsSelect();
        setupPartOrderValidation();
      }
      if (modalName === 'createRun') loadPartsSelect();
    }

    function setupPartOrderValidation() {
      const orderInput = document.getElementById('partOrderNumber');
      const accessBlock = document.getElementById('accessConditionsBlock');
      const sourcePartSelect = document.getElementById('selectSourcePart');
      const scoreMinInput = document.getElementById('accessScoreMin');
      const rankTopInput = document.getElementById('accessRankTop');

      orderInput.addEventListener('input', function() {
        const orderNumber = parseInt(this.value);
        
        if (orderNumber === 1) {
          accessBlock.style.opacity = '0.5';
          accessBlock.style.pointerEvents = 'none';
          sourcePartSelect.value = '';
          scoreMinInput.value = '';
          rankTopInput.value = '';
          sourcePartSelect.disabled = true;
          scoreMinInput.disabled = true;
          rankTopInput.disabled = true;
        } else {
          accessBlock.style.opacity = '1';
          accessBlock.style.pointerEvents = 'auto';
          sourcePartSelect.disabled = false;
          scoreMinInput.disabled = false;
          rankTopInput.disabled = false;
        }
      });
    }

    document.getElementById('formCreateSection').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      try {
        const { data, error } = await supabaseClient
          .from('sections')
          .insert({
            title: formData.get('title'),
            description: formData.get('description') || null,
            participation_cost: parseFloat(formData.get('participation_cost')),
            is_public: formData.get('is_public') === 'on',
            allow_join: formData.get('allow_join') === 'on',
            created_by: (await supabaseClient.from('users').select('id').eq('email', currentUser.email).single()).data.id
          })
          .select();

        if (error) throw error;
        
        alert('‚úÖ Section cr√©√©e avec succ√®s !');
        closeModal('createSection');
        e.target.reset();
        loadSections();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('formCreatePart').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderNumber = parseInt(formData.get('order_number'));
      
      if (orderNumber === 1) {
        const hasAccessConditions = formData.get('access_score_source_part') || 
                                   formData.get('access_score_min') || 
                                   formData.get('access_rank_top');
        
        if (hasAccessConditions) {
          alert('‚ùå Erreur : La premi√®re part (ordre 1) ne peut pas avoir de conditions d\'acc√®s !');
          return;
        }
      }
      
      try {
        const partData = {
          section_id: formData.get('section_id'),
          order_number: orderNumber,
          title: formData.get('title') || null,
          is_active: formData.get('is_active') === 'on'
        };

        if (orderNumber !== 1) {
          if (formData.get('access_score_source_part')) {
            partData.access_score_source_part = formData.get('access_score_source_part');
          }
          if (formData.get('access_score_min')) {
            partData.access_score_min = parseInt(formData.get('access_score_min'));
          }
          if (formData.get('access_rank_top')) {
            partData.access_rank_top = parseInt(formData.get('access_rank_top'));
          }
        }

        const { data, error } = await supabaseClient
          .from('parts')
          .insert(partData)
          .select();

        if (error) throw error;
        
        alert('‚úÖ Part cr√©√©e avec succ√®s !');
        closeModal('createPart');
        e.target.reset();
        allParts = [];
        loadParts();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('formCreateRun').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      try {
        const userId = (await supabaseClient.from('users').select('id').eq('email', currentUser.email).single()).data.id;
        
        const { data, error } = await supabaseClient
          .from('runs')
          .insert({
            part_id: formData.get('part_id'),
            run_number: parseInt(formData.get('run_number')),
            question: formData.get('question'),
            time_limit: parseInt(formData.get('time_limit')),
            admin_answer: formData.get('admin_answer') === 'true',
            published_at: new Date().toISOString(),
            created_by: userId
          })
          .select();

        if (error) throw error;
        
        alert('‚úÖ Run cr√©√© avec succ√®s !');
        closeModal('createRun');
        e.target.reset();
        loadRuns();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('formCreateActualite').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      try {
        const userId = (await supabaseClient.from('users').select('id').eq('email', currentUser.email).single()).data.id;
        
        const { data, error } = await supabaseClient
          .from('posts_actualite')
          .insert({
            title: formData.get('title'),
            content: formData.get('content'),
            image_url: formData.get('image_url') || null,
            created_by: userId
          })
          .select();

        if (error) throw error;
        
        alert('‚úÖ Actualit√© cr√©√©e avec succ√®s !');
        closeModal('createActualite');
        e.target.reset();
        loadActualites();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('formDistributePoints').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const runId = formData.get('run_id');
      const points = parseInt(formData.get('points'));

      if (!confirm('‚ö†Ô∏è Confirmer la distribution de ' + points + ' points par bonne r√©ponse ?')) return;

      try {
        const { data: run, error: runError } = await supabaseClient
          .from('runs')
          .select('*, parts(id)')
          .eq('id', runId)
          .single();

        if (runError) throw runError;

        const { data: answers, error: answersError } = await supabaseClient
          .from('answers')
          .select('*')
          .eq('run_id', runId);

        if (answersError) throw answersError;

        const correctAnswers = answers.filter(a => a.user_answer === run.admin_answer);

        for (const answer of correctAnswers) {
          const { data: currentScore } = await supabaseClient
            .from('scores')
            .select('score')
            .eq('user_id', answer.user_id)
            .eq('part_id', run.parts.id)
            .single();

          if (currentScore) {
            await supabaseClient
              .from('scores')
              .update({ score: currentScore.score + points })
              .eq('user_id', answer.user_id)
              .eq('part_id', run.parts.id);
          } else {
            await supabaseClient
              .from('scores')
              .insert({
                user_id: answer.user_id,
                part_id: run.parts.id,
                score: points
              });
          }
        }

        await supabaseClient
          .from('runs')
          .update({ points_distributed: true })
          .eq('id', runId);

        alert(`‚úÖ Points distribu√©s !\n\nüìä Statistiques:\n- R√©ponses totales: ${answers.length}\n- Bonnes r√©ponses: ${correctAnswers.length}\n- Points par joueur: ${points}\n- Total distribu√©: ${correctAnswers.length * points} points`);
        closeModal('distributePoints');
        loadRuns();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('formUpdateUser').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const userId = formData.get('user_id');
      const role = formData.get('role');
      const status = formData.get('status');

      try {
        const { error } = await supabaseClient
          .from('users')
          .update({ role, status })
          .eq('id', userId);

        if (error) throw error;

        alert('‚úÖ Utilisateur mis √† jour avec succ√®s !');
        closeModal('updateUser');
        loadUsers();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    async function deleteSection(id) {
      if (!confirm('‚ö†Ô∏è Supprimer cette section ? Cette action est irr√©versible.')) return;
      
      try {
        const { error } = await supabaseClient
          .from('sections')
          .delete()
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Section supprim√©e');
        loadSections();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    async function deletePart(id) {
      if (!confirm('‚ö†Ô∏è Supprimer cette part ? Cette action est irr√©versible.')) return;
      
      try {
        const { error } = await supabaseClient
          .from('parts')
          .delete()
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Part supprim√©e');
        loadParts();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    async function closeRun(id) {
      if (!confirm('‚ö†Ô∏è Fermer ce run ? Les joueurs ne pourront plus y r√©pondre.')) return;
      
      try {
        const { error } = await supabaseClient
          .from('runs')
          .update({ is_closed: true })
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Run ferm√© avec succ√®s');
        loadRuns();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    function openDistributePoints(runId, partId, adminAnswer) {
      document.getElementById('distributeRunId').value = runId;
      openModal('distributePoints');
    }

    async function deleteActualite(id) {
      if (!confirm('‚ö†Ô∏è Supprimer cette actualit√© ? Cette action est irr√©versible.')) return;
      
      try {
        const { error } = await supabaseClient
          .from('posts_actualite')
          .delete()
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Actualit√© supprim√©e');
        loadActualites();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    async function deleteUser(id) {
      if (!confirm('‚ö†Ô∏è ATTENTION : Supprimer cet utilisateur ? Toutes ses donn√©es seront perdues.')) return;
      
      try {
        const { error } = await supabaseClient
          .from('users')
          .delete()
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Utilisateur supprim√©');
        loadUsers();
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    function openUpdateUser(userId, role, status) {
      document.getElementById('updateUserId').value = userId;
      document.getElementById('updateUserRole').value = role;
      document.getElementById('updateUserStatus').value = status;
      openModal('updateUser');
    }

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });

    (async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        const { data: userData } = await supabaseClient
          .from('users')
          .select('role, email, username')
          .eq('auth_uid', session.user.id)
          .single();

        if (userData && userData.role === 'admin') {
          currentUser = userData;
          document.getElementById('adminEmail').textContent = userData.email;
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('dashboard').classList.add('active');
          loadDashboardData();
        }
      }
    })();
  </script>
</body>
  </html>
